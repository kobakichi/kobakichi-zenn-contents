---
title: "AWS ElastiCacheã®rename-commandsã§KEYSã‚³ãƒãƒ³ãƒ‰ãŒç„¡åŠ¹åŒ–ã§ããšã«ãƒãƒã£ãŸè©±"
emoji: "ğŸ›¡ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["aws", "elasticache", "redis", "terraform", "security"]
published: true
---
## AWS ElastiCache Redisã®rename-commandsã§ã¯ç©ºæ–‡å­—ã‚’æŒ‡å®šã§ããªã„

æŸITæ¨é€²ä¼æ¥­ã§AWSã‚¤ãƒ³ãƒ•ãƒ©ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¨ã—ã¦åƒã„ã¦ã„ã‚‹kobakichiã§ã™ã€‚
æ™®æ®µã¯Terraformã€Ansibleã‚’ä½¿ã£ã¦ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰ã€ä¿å®ˆã‚’æ‹…å½“ã—ã¦ã„ã¾ã™ã€‚
è‡ªèº«ã®çµŒé¨“ã—ãŸã“ã¨ã€å¤±æ•—ã—ãŸã“ã¨ãªã©ã‚’çš†æ§˜ã«å…±æœ‰ã—ã¦ã„ã“ã†ã¨æ€ã£ã¦ã„ã¾ã™ã€‚
ä»Šå›ã€è«¸ã€…æ¤œè¨¼ã‚’è¡Œãªã£ãŸéš›ã«ãƒãƒã£ãŸäº‹é …ã‚’ã¾ã¨ã‚ã¾ã—ãŸã®ã§å…±æœ‰ã§ã™ï¼

## çµè«–

AWS ElastiCache for Redisã«ãŠã„ã¦ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã¨ã—ã¦ `KEYS` ãªã©ã®å±é™ºãªã‚³ãƒãƒ³ãƒ‰ã‚’rename-commandsã‚’ä½¿ã£ã¦ç„¡åŠ¹åŒ–ã™ã‚‹å ´åˆã€ä»¥ä¸‹ã®ç‚¹ã«æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚

1. **ç©ºæ–‡å­— `""` ã¯ä½¿ãˆãªã„**ï¼š
    - OSSç‰ˆRedisã§ã¯ç©ºæ–‡å­—ã¸ã®ãƒªãƒãƒ¼ãƒ ã§ç„¡åŠ¹åŒ–ã§ãã¾ã™ãŒã€AWSã®ElastiCacheã§ã¯ã€Œå…¥åŠ›ä¸è¶³ã€ã®ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚ï¼ˆå¾Œã»ã©ã‚¨ãƒ©ãƒ¼å†…å®¹ã‚’èª¬æ˜ã—ã¾ã™ï¼‰
2. **ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ `_` ã¯ä½¿ãˆãªã„**ï¼š
    - ãƒªãƒãƒ¼ãƒ å¾Œã®ã‚³ãƒãƒ³ãƒ‰åã¯ **è‹±æ•°å­— (Alphanumeric)** ã®ã¿è¨±å¯ã•ã‚Œã¦ã„ã¾ã™ã€‚
3. **è§£æ±ºç­–**ï¼š
    - **ã€Œæ¨æ¸¬ä¸å¯èƒ½ãªãƒ©ãƒ³ãƒ€ãƒ ãªè‹±æ•°å­—åˆ—ã€** ã«ãƒªãƒãƒ¼ãƒ ã™ã‚‹ã“ã¨ã§ã€å®Ÿè³ªçš„ãªç„¡åŠ¹åŒ–ã‚’è¡Œã„ã¾ã™ã€‚

## èƒŒæ™¯

Redisã®`KEYS`ã‚³ãƒãƒ³ãƒ‰ã¯ã€å¤§é‡ã®ã‚­ãƒ¼ãŒå­˜åœ¨ã™ã‚‹å ´åˆã«å®Ÿè¡Œã™ã‚‹ã¨ã‚µãƒ¼ãƒãƒ¼ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’è‘—ã—ãä½ä¸‹ã•ã›ã€æœ€æ‚ªã®å ´åˆã‚µãƒ¼ãƒ“ã‚¹åœæ­¢ï¼ˆãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ï¼‰ã‚’å¼•ãèµ·ã“ã™å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
ãã®ãŸã‚ã€ã“ã®ã‚³ãƒãƒ³ãƒ‰ã‚’é–‹ç™ºè€…ãŒèª¤ã£ã¦å®Ÿè¡Œã§ããªã„ã‚ˆã†ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚°ãƒ«ãƒ¼ãƒ—ã® `rename-commands` ã‚’ä½¿ã£ã¦ç„¡åŠ¹åŒ–ã—ã‚ˆã†ã¨ã—ã¾ã—ãŸã€‚

## è©¦ã—ãŸã“ã¨ã¨ç™ºç”Ÿã—ãŸã‚¨ãƒ©ãƒ¼

### 1. ç©ºæ–‡å­— `""` ã§ç„¡åŠ¹åŒ–ã—ã‚ˆã†ã¨ã—ãŸï¼ˆå¤±æ•—ï¼‰

OSSç‰ˆRedisã§ã¯ã€ç©ºæ–‡å­—ã¸ã®ãƒªãƒãƒ¼ãƒ ã§ç„¡åŠ¹åŒ–ã§ãã¾ã™ãŒã€AWSã®ElastiCacheã§ã¯ã€Œå…¥åŠ›ä¸è¶³ã€ã®ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚

```
KEYS ""
```

**çµæœï¼šã‚¨ãƒ©ãƒ¼**

> Insufficient input provided. Renaming command requires a pair of inputs containing an original Redis command name and a new command name.
> 

ElastiCacheã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆãŠã‚ˆã³APIï¼‰ã§ã¯ã€ç©ºæ–‡å­—ã¯ã€Œæœ‰åŠ¹ãªå…¥åŠ›ã€ã¨ã¿ãªã•ã‚Œãšã€ã€Œãƒªãƒãƒ¼ãƒ å…ˆã®åå‰ãŒå…¥åŠ›ã•ã‚Œã¦ã„ãªã„ã€ã¨åˆ¤å®šã•ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚

### 2. ã‚ã‹ã‚Šã‚„ã™ã„åå‰ã«ãƒªãƒãƒ¼ãƒ ã—ã‚ˆã†ã¨ã—ãŸï¼ˆå¤±æ•—ï¼‰

ã€Œç„¡åŠ¹åŒ–ã•ã‚ŒãŸã‚­ãƒ¼ã€ã ã¨ã‚ã‹ã‚‹ã‚ˆã†ã«ã€`DISABLED_KEYS` ã¨ã„ã†åå‰ã‚’ä»˜ã‘ã‚ˆã†ã¨ã—ã¾ã—ãŸã€‚

```
KEYS "DISABLED_KEYS"
```

**çµæœï¼šã‚¨ãƒ©ãƒ¼**

> Renamed parameter expected to be alphanumeric
> 

ElastiCacheã®ä»•æ§˜ã¨ã—ã¦ã€ãƒªãƒãƒ¼ãƒ å¾Œã®ã‚³ãƒãƒ³ãƒ‰åã«ã¯ **è‹±æ•°å­— (A-Z, 0-9) ã®ã¿** ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã™ã€‚ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ `_` ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚

## æ­£ã—ã„è¨­å®šæ–¹æ³•ï¼ˆè§£æ±ºç­–ï¼‰

ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨AWSã®ä»•æ§˜ã‚’è¸ã¾ãˆã€**ã€Œè‹±æ•°å­—ã®ã¿ã€** ã‹ã¤ **ã€Œèª°ã‚‚å®Ÿè¡Œã§ããªã„ï¼ˆæ¨æ¸¬ã§ããªã„ï¼‰ã€** æ–‡å­—åˆ—ã«ãƒªãƒãƒ¼ãƒ ã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

### æˆåŠŸã—ãŸè¨­å®š

```
KEYS "KEYS8d9a8f9s8d"
```

â€» `DISABLEDKEYS` ã§ã‚‚è¨­å®šè‡ªä½“ã¯å¯èƒ½ã§ã™ãŒã€æ¨æ¸¬ã•ã‚Œã¦å®Ÿè¡Œã•ã‚Œã‚‹ãƒªã‚¹ã‚¯ãŒã‚ã‚‹ãŸã‚ã€ä¹±æ•°ã‚’å«ã‚ã‚‹ã®ãŒè‰¯ã•ãã†ã§ã™ã€‚

### ã€è¿½è¨˜ã€‘å…¬å¼æ¨å¥¨ã®è¨­å®š

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å†ç¢ºèªã—ãŸã¨ã“ã‚ã€å®Œå…¨ã«ç„¡åŠ¹åŒ–ã—ãŸã„å ´åˆã¯ `blocked` ã¨ã„ã†ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ã†ã®ãŒå…¬å¼æ¨å¥¨ã¨è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚

> To prevent a command's use entirely, use the keyword **blocked**

ã“ã‚Œã‚’ä½¿ã†ã¨ã€ã‚ˆã‚Šæ„å›³ãŒæ˜ç¢ºã«ãªã‚Šã€ãƒ©ãƒ³ãƒ€ãƒ ãªæ–‡å­—åˆ—ã‚’è€ƒãˆã‚‹å¿…è¦ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚

```
KEYS blocked
```

## Terraformã§ã®å®Ÿè£…ä¾‹

Terraformã§è¨­å®šã™ã‚‹å ´åˆã¯ã€`aws_elasticache_parameter_group` ãƒªã‚½ãƒ¼ã‚¹ã«ä»¥ä¸‹ã®ã‚ˆã†ã«è¨˜è¿°ã—ã¾ã™ã€‚

```hcl
resource "aws_elasticache_parameter_group" "redis" {
  name   = "example-redis"
  family = "redis7"

  # KEYSã‚³ãƒãƒ³ãƒ‰ã‚’ç„¡åŠ¹åŒ–ï¼ˆblockedæ¨å¥¨ï¼‰
  parameter {
    name  = "rename-commands"
    value = "KEYS blocked"
  }
}
```

è¤‡æ•°ã®ã‚³ãƒãƒ³ãƒ‰ï¼ˆä¾‹: `FLUSHALL` ã¨ `FLUSHDB`ï¼‰ã‚‚åŒæ™‚ã«ç„¡åŠ¹åŒ–ã—ãŸã„å ´åˆã¯ã€ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šã§è¨˜è¿°ã—ã¾ã™ã€‚

```hcl
  parameter {
    name  = "rename-commands"
    value = "KEYS KEYS8d9a8f9s8d FLUSHALL FLUSHALL7s8d6f FLUSHDB FLUSHDB3k4j5h"
  }
```

## ã¾ã¨ã‚

ElastiCacheã¯ãƒãƒãƒ¼ã‚¸ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã§ã‚ã‚‹ãŸã‚ã€OSSç‰ˆã®Redisã¨ã¯ä¸€éƒ¨æŒ™å‹•ã‚„åˆ¶ç´„ï¼ˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ãŒç•°ãªã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã—ãŸã€‚
ã€Œã‚³ãƒãƒ³ãƒ‰ã®ç„¡åŠ¹åŒ–ï¼ç©ºæ–‡å­—ã€ã¨ã„ã†å½¢ã§ã¯è¨­å®šã§ããªã„ãŸã‚ã€**ã€Œãƒ©ãƒ³ãƒ€ãƒ ãªè‹±æ•°å­—ã¸ã®ãƒªãƒãƒ¼ãƒ ã€** ã§å¯¾å¿œã—ã¾ã—ã‚‡ã†ã€‚

## å‚è€ƒè¨˜äº‹

- [Redis security | Redis](https://redis.io/docs/latest/operate/oss_and_stack/management/security/#disallowing-specific-commands)
- [Engine specific parameters | Amazon ElastiCache](https://docs.aws.amazon.com/AmazonElastiCache/latest/dg/ParameterGroups.Engine.html)
- [ElastiCache version 5.0.6 (rename-commands limitations) | Amazon ElastiCache](https://docs.aws.amazon.com/AmazonElastiCache/latest/dg/engine-versions.html#redis-version-5-0.6)